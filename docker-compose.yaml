services:
  # --- БАЗА ДАННЫХ (Home Assistant) ---
  homeassistant-db:
    image: postgres:latest
    container_name: homeassistant-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: homeassistant-db
      POSTGRES_USER: dbuser
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - /apps/postgresql/data:/var/lib/postgresql/data

  # --- MQTT ---
  mqtt:
    image: eclipse-mosquitto
    container_name: mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - /apps/mosquitto/config:/mosquitto/config
      - /apps/mosquitto/data:/mosquitto/data

  # --- ZIGBEE2MQTT ---
  zigbee2mqtt:
    image: koenkk/zigbee2mqtt
    container_name: zigbee2mqtt
    restart: unless-stopped
    depends_on: [mqtt]
    ports:
      - "8080:8080"
    volumes:
      - /apps/zigbee2mqtt/data:/app/data
      - /run/udev:/run/udev:ro
    devices:
      - /dev/serial/by-id/usb-ITead_Sonoff_Zigbee_3.0_USB_Dongle_Plus_88729ed0803bec11a4d2a4957a0af07f-if00-port0:/dev/ttyUSB0
    environment:
      - TZ=${TIMEZONE}

  # --- HOME ASSISTANT ---
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    privileged: true
    network_mode: host
    depends_on: [homeassistant-db, mqtt]
    volumes:
      - /apps/homeassistant/config:/config
      - /run/dbus:/run/dbus:ro

  # --- MATTER ---
  matter-server:
    image: ghcr.io/home-assistant-libs/python-matter-server:stable
    container_name: matter-server
    restart: unless-stopped
    network_mode: host
    security_opt: [apparmor=unconfined]
    volumes:
      - /apps/matter/data:/data
      - /run/dbus:/run/dbus:ro
    command: --storage-path /data --paa-root-cert-dir /data/credentials --bluetooth-adapter 0

  # --- ГОЛОСОВЫЕ СЕРВИСЫ ---
  whisper:
    image: rhasspy/wyoming-whisper
    container_name: whisper
    command: --model tiny-int8 --language ru
    volumes:
      - /apps/whisper/data:/data

  piper:
    image: rhasspy/wyoming-piper
    container_name: piper
    command: --voice ru_RU-irina-medium
    volumes:
      - /apps/piper/data:/data

  # --- JELLYFIN (Транскодинг через NVIDIA) ---
  jellyfin:
    image: jellyfin/jellyfin
    container_name: jellyfin
    restart: unless-stopped
    network_mode: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      - /apps/jellyfin/config:/config
      - ${STORAGE_ROOT}/movies:/data/movies
      - ${STORAGE_ROOT}/tvshows:/data/tvshows

  # --- IMMICH (Транскодинг через Intel QuickSync) ---
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION}
    container_name: immich_server
    restart: always
    volumes:
      - ${UPLOAD_LOCATION}:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    env_file: [.env]
    ports: ["2283:2283"]
    devices:
      - /dev/dri:/dev/dri
    depends_on: [immich-db, immich-redis]

  immich-db:
    image: postgres:14-alpine
    container_name: immich_postgres
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: postgres
      POSTGRES_DB: immich
    volumes:
      - /apps/immich/db:/var/lib/postgresql/data

  immich-redis:
    image: redis:6.2-alpine
    container_name: immich_redis

  # --- AI / LLM (Ollama на NVIDIA) ---
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      - /apps/ollama:/root/.ollama

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports: ["3000:8080"]
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    volumes:
      - /apps/open-webui:/app/data
    depends_on: [ollama]
